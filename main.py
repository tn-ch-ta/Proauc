# main.py
import random
from fetchers.youtube_fetcher import search_youtube_short_videos
from downloaders.downloader import download_with_ytdlp
from editor import compose_short
from uploader import upload_video


def main():
    print("ğŸ” Searching YouTube for trending funny/viral shorts...")
    # Fetch curated videos from YouTube only
    yt_videos = search_youtube_short_videos(
        tags=("rdr2", "reddeadredemption2", "rdro"),
        max_results=50,
        max_total_duration=61,
        min_likes=1000,
        max_clips=3,
    )

    if not yt_videos:
        print("âŒ No suitable YouTube shorts found. Exiting.")
        return

    print(f"âœ… Found {len(yt_videos)} clips within duration limit.")
    for i, v in enumerate(yt_videos, start=1):
        print(f"   {i}. {v['title']} ({v['duration']}s)")

    # 2ï¸âƒ£ Download the selected clips
    downloaded_paths = []
    for i, vid in enumerate(yt_videos):
        try:
            print(f"â¬‡ï¸  Downloading clip {i + 1}/{len(yt_videos)}: {vid['title']}")
            path = download_with_ytdlp(vid["url"], filename_prefix=f"clip{i}")
            downloaded_paths.append(path)
        except Exception as e:
            print(f"âš ï¸  Failed to download {vid.get('url')}: {e}")

    if not downloaded_paths:
        print("âŒ No clips were successfully downloaded.")
        return

    # 3ï¸âƒ£ Compose into one vertical short (labels now auto-generated in editor.py)
    print("ğŸ¬ Editing and compiling video...")
    output_path = compose_short(downloaded_paths, output_filename="final_short.mp4")
    print(f"âœ… Final short created at: {output_path}")

    # 4ï¸âƒ£ Use the funny title generated by editor.py
    title = getattr(output_path, "ai_generated_title", None)
    if not title:
        title = "Funny Compilation Shorts ğŸ˜‚"
    print(f"ğŸ“ Using AI-generated title: {title}")

    # 5ï¸âƒ£ Upload to YouTube
    print("ğŸ“¤ Uploading to YouTube...")

    try:
        response = upload_video(
            file_path=output_path,
            title=title,
            description="Compilation of trending funny and viral shorts automatically created by the bot.",
            tags=["shorts", "funny", "viral", "compilation", "trending"],
            privacy="public"
        )
        print("âœ… Upload completed successfully!")
        print(f"ğŸ¬ Video URL: https://www.youtube.com/watch?v={response.get('id', 'UNKNOWN')}")
    except Exception as e:
        print(f"âŒ Upload failed: {e}")

if __name__ == "__main__":
    main()